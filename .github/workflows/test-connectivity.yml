name: ğŸ” Tests de ConnectivitÃ© - Simulation d'Erreurs

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # Permet de dÃ©clencher manuellement

jobs:
  connectivity-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: ğŸš€ Start services (DB + Backend)
      run: |
        echo "DÃ©marrage des services..."
        docker compose up -d db backend
        sleep 15
        
    - name: ğŸ” Test 1: Backend accessible
      run: |
        echo "Test de connectivitÃ© au backend..."
        docker compose run --rm test python -c "
        import requests
        try:
            response = requests.get('http://backend:8000/health', timeout=5)
            print('âœ… Backend accessible - Status:', response.status_code)
        except Exception as e:
            print('âŒ Backend inaccessible:', e)
            exit(1)
        "
    
    - name: âŒ Test 2: Simulation d'erreur (doit Ã©chouer)
      run: |
        echo "Simulation d'erreur de connectivitÃ©..."
        docker compose run --rm test python -c "
        import requests
        print('ğŸ” Test de connectivitÃ© Ã  un port inexistant...')
        try:
            response = requests.get('http://backend:9999/health', timeout=2)
            print('âŒ Connexion inattendue - ce test devrait Ã©chouer')
            exit(1)
        except Exception as e:
            print('âŒ Erreur de connectivitÃ© simulÃ©e dÃ©tectÃ©e:', e)
            print('âœ… La dÃ©tection automatique d erreur fonctionne!')
            exit(1)  # Force l'Ã©chec pour dÃ©montrer la dÃ©tection
        "
      continue-on-error: true
    
    - name: ğŸ§ª Test 3: Tests pytest avec erreurs intentionnelles
      run: |
        echo "Lancement des tests de connectivitÃ© avec pytest..."
        docker compose run --rm test pytest test_connectivity.py -v
      continue-on-error: true
    
    - name: ğŸ“Š Show test results
      if: always()
      run: |
        echo "ğŸ“‹ RÃ©sultats des tests de connectivitÃ©:"
        docker compose logs backend | tail -20
        
    - name: ğŸ§¹ Cleanup
      if: always()
      run: |
        docker compose down -v
        docker system prune -f
