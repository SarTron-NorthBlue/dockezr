---
# Playbook Ansible pour dÃ©ployer DockeZR
# Ce playbook installe Docker, clone le repository et lance l'application

- name: "DÃ©ploiement automatisÃ© de DockeZR sur serveur Linux"
  hosts: all
  become: yes
  gather_facts: yes

  tasks:
    # ====================================================================
    # Ã‰TAPE 1 : Mise Ã  jour du systÃ¨me et installation des prÃ©requis
    # ====================================================================
    - name: "[1/10] ğŸ”„ Mise Ã  jour du cache APT"
      apt:
        update_cache: yes
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"

    - name: "[1/10] ğŸ“¦ Installation des paquets systÃ¨me requis"
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
          - git
          - python3
          - python3-pip
        state: present
      when: ansible_os_family == "Debian"

    # ====================================================================
    # Ã‰TAPE 2 : Installation de Docker
    # ====================================================================
    - name: "[2/10] ğŸ³ VÃ©rification si Docker est dÃ©jÃ  installÃ©"
      command: docker --version
      register: docker_installed
      ignore_errors: yes
      changed_when: false

    - name: "[2/10] ğŸ“ CrÃ©ation du rÃ©pertoire pour les clÃ©s GPG"
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'
      when: docker_installed.rc != 0

    - name: "[2/10] ğŸ”‘ Ajout de la clÃ© GPG officielle de Docker"
      shell: |
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
        chmod a+r /etc/apt/keyrings/docker.gpg
      args:
        creates: /etc/apt/keyrings/docker.gpg
      when: docker_installed.rc != 0 and ansible_distribution == "Ubuntu"

    - name: "[2/10] ğŸ“ Ajout du repository Docker"
      apt_repository:
        repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present
        filename: docker
      when: docker_installed.rc != 0 and ansible_distribution == "Ubuntu"

    - name: "[2/10] ğŸ³ Installation de Docker Engine"
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present
        update_cache: yes
      when: docker_installed.rc != 0

    - name: "[2/10] âœ… VÃ©rification que Docker est dÃ©marrÃ© et activÃ© au boot"
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: "[2/10] ğŸ‘¤ Ajout de l'utilisateur au groupe docker"
      user:
        name: "{{ deploy_user }}"
        groups: docker
        append: yes

    # ====================================================================
    # Ã‰TAPE 3 : Installation de Docker Compose (si nÃ©cessaire)
    # ====================================================================
    - name: "[3/10] ğŸ” VÃ©rification de Docker Compose"
      command: docker compose version
      register: compose_check
      ignore_errors: yes
      changed_when: false

    - name: "[3/10] âœ… Docker Compose est installÃ©"
      debug:
        msg: "Docker Compose est dÃ©jÃ  disponible via le plugin Docker"
      when: compose_check.rc == 0

    # ====================================================================
    # Ã‰TAPE 4 : PrÃ©paration des rÃ©pertoires
    # ====================================================================
    - name: "[4/10] ğŸ“ CrÃ©ation du rÃ©pertoire de dÃ©ploiement"
      file:
        path: "{{ deploy_dir }}"
        state: directory
        owner: "{{ deploy_user }}"
        group: "{{ deploy_user }}"
        mode: '0755'

    # ====================================================================
    # Ã‰TAPE 5 : Clonage du repository Git
    # ====================================================================
    - name: "[5/10] ğŸ” VÃ©rification si le repository existe dÃ©jÃ "
      stat:
        path: "{{ deploy_dir }}/.git"
      register: git_repo

    - name: "[5/10] ğŸ“¥ Clonage du repository GitHub"
      git:
        repo: "{{ project_repo }}"
        dest: "{{ deploy_dir }}"
        version: "{{ project_branch }}"
        force: yes
      become_user: "{{ deploy_user }}"
      when: not git_repo.stat.exists

    - name: "[5/10] ğŸ”„ Mise Ã  jour du repository existant"
      git:
        repo: "{{ project_repo }}"
        dest: "{{ deploy_dir }}"
        version: "{{ project_branch }}"
        force: yes
      become_user: "{{ deploy_user }}"
      when: git_repo.stat.exists

    # ====================================================================
    # Ã‰TAPE 6 : Configuration des variables d'environnement
    # ====================================================================
    - name: "[6/10] âš™ï¸ CrÃ©ation du fichier .env.prod depuis le template"
      template:
        src: templates/env.prod.j2
        dest: "{{ deploy_dir }}/.env.prod"
        owner: "{{ deploy_user }}"
        group: "{{ deploy_user }}"
        mode: '0600'

    # ====================================================================
    # Ã‰TAPE 7 : ArrÃªt des conteneurs existants (si prÃ©sents)
    # ====================================================================
    - name: "[7/10] ğŸ›‘ ArrÃªt des conteneurs existants (si prÃ©sents)"
      command: docker compose -f docker-compose.prod.yml down
      args:
        chdir: "{{ deploy_dir }}"
      become_user: "{{ deploy_user }}"
      ignore_errors: yes
      tags: stop

    # ====================================================================
    # Ã‰TAPE 8 : Construction des images Docker
    # ====================================================================
    - name: "[8/10] ğŸ—ï¸ Construction des images Docker"
      command: docker compose -f docker-compose.prod.yml build --no-cache
      args:
        chdir: "{{ deploy_dir }}"
      become_user: "{{ deploy_user }}"
      tags: build

    # ====================================================================
    # Ã‰TAPE 9 : DÃ©marrage des conteneurs
    # ====================================================================
    - name: "[9/10] ğŸš€ DÃ©marrage des conteneurs en arriÃ¨re-plan"
      command: docker compose -f docker-compose.prod.yml up -d
      args:
        chdir: "{{ deploy_dir }}"
      become_user: "{{ deploy_user }}"
      tags: start

    # ====================================================================
    # Ã‰TAPE 10 : VÃ©rification du dÃ©ploiement
    # ====================================================================
    - name: "[10/10] â³ Attente du dÃ©marrage des services (30 secondes)"
      pause:
        seconds: 30

    - name: "[10/10] ğŸ” VÃ©rification de l'Ã©tat des conteneurs"
      command: docker compose -f docker-compose.prod.yml ps
      args:
        chdir: "{{ deploy_dir }}"
      become_user: "{{ deploy_user }}"
      register: containers_status
      changed_when: false

    - name: "[10/10] ğŸ“Š Affichage de l'Ã©tat des conteneurs"
      debug:
        var: containers_status.stdout_lines

    - name: "[10/10] ğŸ“ RÃ©cupÃ©ration des logs rÃ©cents"
      command: docker compose -f docker-compose.prod.yml logs --tail=20
      args:
        chdir: "{{ deploy_dir }}"
      become_user: "{{ deploy_user }}"
      register: container_logs
      changed_when: false

    - name: "[10/10] ğŸ“‹ Affichage des logs"
      debug:
        var: container_logs.stdout_lines

    # ====================================================================
    # RÃ‰SUMÃ‰ FINAL
    # ====================================================================
    - name: "âœ… DÃ©ploiement terminÃ© avec succÃ¨s!"
      debug:
        msg:
          - "ğŸ‰ L'application DockeZR a Ã©tÃ© dÃ©ployÃ©e avec succÃ¨s!"
          - ""
          - "ğŸŒ AccÃ¨s aux services:"
          - "   - Frontend:    http://{{ ansible_host }}:{{ frontend_port }}"
          - "   - Backend API: http://{{ ansible_host }}:{{ backend_port }}"
          - "   - Swagger:     http://{{ ansible_host }}:{{ backend_port }}/docs"
          - "   - Prometheus:  http://{{ ansible_host }}:{{ prometheus_port }}"
          - "   - Grafana:     http://{{ ansible_host }}:{{ grafana_port }}"
          - ""
          - "ğŸ“ RÃ©pertoire de dÃ©ploiement: {{ deploy_dir }}"
          - ""
          - "ğŸ”§ Commandes utiles:"
          - "   - Voir les logs:      cd {{ deploy_dir }} && docker compose -f docker-compose.prod.yml logs -f"
          - "   - RedÃ©marrer:         cd {{ deploy_dir }} && docker compose -f docker-compose.prod.yml restart"
          - "   - ArrÃªter:            cd {{ deploy_dir }} && docker compose -f docker-compose.prod.yml down"

